### **Шаги установки**

#### Создаём виртуальное окружение
```python -m venv venv```

#### Активируем виртуальное окружение
```source venv/bin/activate```

#### Устанавливем зависимости
```pip install -r requirements.txt```

#### Запускаем 
```python main.py```


# Image Similarity Search with ORB and RANSAC

## Алгоритм

В этом проекте используется алгоритм **ORB (Oriented FAST and Rotated BRIEF)** для извлечения ключевых точек и дескрипторов изображения, а также **RANSAC (Random Sample Consensus)** для фильтрации ложных совпадений при поиске схожих изображений. Рассмотрим теоретический подход более подробно.

### Основной алгоритм:

1. **ORB (Oriented FAST and Rotated BRIEF)**:
    - Это комбинированный алгоритм, который использует два этапа: FAST для детектирования ключевых точек и BRIEF для их описания. 
    - В ORB добавлены улучшения, такие как ориентация (учет угла поворота) и обработка яркости для повышения устойчивости к изменениям в изображении (например, изменениям угла обзора или освещения).
    - ORB эффективен и быстро работает, не требуя большой вычислительной мощности, что делает его подходящим для работы с большими коллекциями изображений.

2. **RANSAC (Random Sample Consensus)**:
    - RANSAC используется для определения правильных совпадений между ключевыми точками двух изображений. Он помогает избавиться от ложных совпадений, которые могут быть вызваны шумом или другими искажениями.
    - Суть метода заключается в том, что он повторяет процесс отбора случайных подмножеств точек и находит модель (гомографию), которая лучше всего объясняет эти точки. При этом выбрасываются точки, которые не соответствуют найденной модели.

### Подготовка базы изображений

Для начала работы с системой необходимо подготовить базу данных изображений, которая будет использоваться для поиска. Каждый элемент в базе данных представляет собой запись, содержащую три ключевых компонента:

1. **Ключевые точки (Keypoints)**:
    - Это координаты точек интереса на изображении, которые будут использоваться для дальнейшего вычисления дескрипторов.
    - В каждой записи хранятся координаты ключевых точек и их размер.
    - Пример формата:
      ```python
      keypoints_data = [(x1, y1, size1), (x2, y2, size2), ...]
      ```

2. **Дескриптор (Descriptors)**:
    - Это набор числовых признаков, который представляет собой описание местоположения и структуры ключевых точек на изображении. ORB генерирует дескрипторы для каждой ключевой точки.
    - Пример формата:
      ```python
      des2 = np.array([descriptor1, descriptor2, ...])
      ```

3. **Гистограмма (Histogram)**:
    - Гистограмма — это статистика распределения цветов изображения, которая также используется для сравнения изображений на основе их цветового состава.
    - В проекте используется трехмерная гистограмма для цветовых каналов (RGB), которая делится на 8 бинов для каждого канала, в итоге создавая 512-мерный вектор.
    - Пример формата:
      ```python
      hist = np.array([histogram_data])
      ```

### Структура базы данных:

Каждая запись базы данных будет иметь следующую структуру:

```python
image_data = {
    "image_name": (
        keypoints_data,  # Список координат ключевых точек
        des2,            # Дескрипторы
        hist             # Гистограмма
    )
}
```

Пример записи для изображения "image1.jpg":

```python
image_data = {
    "image1.jpg": (
        [(100.5, 150.5, 31), (200.4, 250.1, 30), ...],  # Ключевые точки
        np.array([[25, 30, 14, 13, ...], [13, 11, 30, 45, ...], ...]),  # Дескрипторы
        np.array([0.1, 0.5, 0.3, 0.4, ...])  # Гистограмма
    )
}
```

### Функция поиска похожих изображений

Теперь рассмотрим основную функцию, которая занимается поиском похожих изображений на основе входного изображения. Вся функция делится на несколько этапов:

#### 1. **Загрузка входного изображения и его предобработка**:
   В первой части функции загружается входное изображение, и оно конвертируется в оттенки серого для дальнейшего использования в алгоритме ORB. Также рассчитывается гистограмма цвета для этого изображения.

```python
input_img = cv2.imread(input_image_path)
input_img_gray = cv2.cvtColor(input_img, cv2.COLOR_BGR2GRAY)
kp1, des1 = orb.detectAndCompute(input_img_gray, None)
input_hist = cv2.calcHist([input_img], [0, 1, 2], None, [8, 8, 8], [0, 256, 0, 256, 0, 256])
input_hist = cv2.normalize(input_hist, input_hist).flatten()
```

- `cv2.imread()` загружает изображение.
- `cv2.cvtColor()` конвертирует изображение в оттенки серого для работы с ORB.
- `orb.detectAndCompute()` находит ключевые точки и вычисляет их дескрипторы.
- `cv2.calcHist()` рассчитывает гистограмму для цветовых каналов изображения.

#### 2. **Загрузка базы данных изображений**:
   Функция открывает файл, в котором содержатся дескрипторы и гистограммы для всех изображений в базе данных. Эти данные загружаются с помощью библиотеки **pickle**.

```python
with open(descriptors_file, "rb") as f:
    image_data = pickle.load(f)
```

#### 3. **Сравнение изображений по ORB дескрипторам**:
   Для каждого изображения в базе данных сравниваются дескрипторы с дескрипторами входного изображения. Используется **метод k-Nearest Neighbors (k-NN)**, чтобы найти лучшие совпадения.

```python
matches = bf.knnMatch(des1, des2, k=2)
good_matches = [m for m, n in matches if m.distance < 0.70 * n.distance]
```

- `bf.knnMatch()` находит два ближайших совпадения для каждого дескриптора из входного изображения.
- Хорошие совпадения выбираются на основе расстояния, если оно меньше 70% от расстояния второго ближайшего совпадения.

#### 4. **Применение RANSAC для фильтрации совпадений**:
   Для избежания ложных совпадений применяется **RANSAC**, который вычисляет гомографию между ключевыми точками двух изображений и фильтрует неверные совпадения.

```python
_, mask = cv2.findHomography(src_pts, dst_pts, cv2.RANSAC, 5.0)
filtered_matches = [m for m, is_valid in zip(good_matches, mask.ravel()) if is_valid]
```

- `cv2.findHomography()` вычисляет гомографию, используя метод RANSAC, который фильтрует неподтвержденные совпадения.
- Совпадения, прошедшие фильтрацию, используются для вычисления общей оценки схожести.

#### 5. **Сравнение гистограмм**:
   Гистограмма входного изображения сравнивается с гистограммами каждого изображения из базы данных с помощью метода **корреляции**.

```python
hist_score = cv2.compareHist(input_hist, hist2, cv2.HISTCMP_CORREL)
```

#### 6. **Комбинированная оценка схожести**:
   Наконец, комбинированная оценка вычисляется как взвешенная сумма оценок по ORB и гистограмме.

```python
combined_score = (orb_score * orb_weight) + (1 - hist_score) * (1 - orb_weight)
```

Этот итоговый балл используется для сортировки изображений и поиска наиболее похожих.

---